#!/bin/bash

# –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Telegram –±–æ—Ç–∞
# –ê–≤—Ç–æ—Ä: MPR_XO
# –í–µ—Ä—Å–∏—è: 1.0

set -e

echo "üöÄ –ë–´–°–¢–†–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï TELEGRAM –ë–û–¢–ê"
echo "======================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root: sudo bash deploy.sh"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
echo ""
echo "üîë –ù–ê–°–¢–†–û–ô–ö–ê –¢–û–ö–ï–ù–ê –ë–û–¢–ê"
echo "========================="
echo "–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –≤ Telegram"
read -p "–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞: " BOT_TOKEN

if [ -z "$BOT_TOKEN" ]; then
    echo "‚ùå –¢–æ–∫–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
read -p "–ü—É—Ç—å –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞ [/opt/telegram-bot]: " INSTALL_PATH
INSTALL_PATH=${INSTALL_PATH:-/opt/telegram-bot}

echo ""
echo "üìã –ü–ê–†–ê–ú–ï–¢–†–´ –£–°–¢–ê–ù–û–í–ö–ò"
echo "======================"
echo "–¢–æ–∫–µ–Ω –±–æ—Ç–∞: ${BOT_TOKEN:0:10}..."
echo "–ü—É—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏: $INSTALL_PATH"
echo ""

read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É? (y/N): " CONFIRM
if [[ ! $CONFIRM =~ ^[Yy]$ ]]; then
    echo "‚ùå –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
mkdir -p $INSTALL_PATH
cd $INSTALL_PATH

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞)
echo "üìÅ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞..."
cp -r "$(dirname "$0")"/* .

# –ó–∞–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
echo "‚öôÔ∏è –ó–∞–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É..."
chmod +x install.sh
bash install.sh

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω
echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
cp env.example .env
sed -i "s/your_bot_token_here/$BOT_TOKEN/g" .env

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
telegram-bot start

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo ""
echo "üìä –ü–†–û–í–ï–†–ö–ê –£–°–¢–ê–ù–û–í–ö–ò"
echo "===================="
sleep 5
telegram-bot status

echo ""
echo "‚úÖ –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo ""
echo "üìã –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´:"
echo "telegram-bot start    - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
echo "telegram-bot stop     - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞"
echo "telegram-bot status   - –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞"
echo "telegram-bot logs     - –õ–æ–≥–∏ –±–æ—Ç–∞"
echo "telegram-bot restart  - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
echo ""
echo "üìÅ –§–∞–π–ª—ã –±–æ—Ç–∞: $INSTALL_PATH"
echo "üìã –õ–æ–≥–∏: telegram-bot logs"
echo ""
echo "üéâ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!"
echo "–ù–∞–π–¥–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start"
